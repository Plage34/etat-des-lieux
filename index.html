<!doctype html>
<html lang="fr"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,viewport-fit=cover">
  <title>Ã‰tat des lieux â€“ Location Valras</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ã‰tat des Lieux">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-accent-1: #667eea;
      --bg-accent-2: #764ba2;
      --muted: #f5f7fb;
      --card: #ffffff;
      --success: #10b981;
      --danger: #ef4444;
      --radius: 12px;
      --gap: 14px;
      --max-width: 1100px;
      --shadow: 0 14px 40px rgba(26, 32, 44, 0.12);
      --text: #1f2937;
      --muted-text: #6b7280;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    
    /* PWA iOS safe areas */
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg-accent-1) 0%, var(--bg-accent-2) 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      padding-top: max(28px, env(safe-area-inset-top));
      padding-bottom: max(28px, env(safe-area-inset-bottom));
      padding-left: max(28px, env(safe-area-inset-left));
      padding-right: max(28px, env(safe-area-inset-right));
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      -webkit-overflow-scrolling: touch;
    }

    .app{
      width:100%;
      max-width:var(--max-width);
      background:var(--card);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow);
      margin-bottom:28px;
    }

    .toolbar{
      position:sticky;
      top:0;
      background:linear-gradient(90deg,var(--bg-accent-1),var(--bg-accent-2));
      padding:16px;
      color:white;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      z-index:40;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .toolbar h3{margin:0; font-size:16px; font-weight:600}
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .btn.positive{background:rgba(255,255,255,0.12); color:white}
    .btn.ghost{background:transparent; color:white; border:1px solid rgba(255,255,255,0.08)}
    .btn.warn{background:#f59e0b; color:white}
    .btn.success{background:var(--success); color:white}
    .btn.danger{background:var(--danger); color:white}

    .content{
      padding:28px;
      display:grid;
      grid-template-columns: 1fr;
      gap:20px;
    }

    .header{
      background:linear-gradient(135deg,var(--bg-accent-1),var(--bg-accent-2));
      color:white;
      padding:40px 28px;
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
      min-height:auto;
    }
    .header h1{margin:0; font-size:28px; font-weight:700; letter-spacing:1px}
    .header p{margin:8px 0 0 0; color:rgba(255,255,255,0.9); font-size:14px}

    .info-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:20px;
      margin-top:28px;
      page-break-inside: avoid;
      break-inside: avoid;
    }
      gap:18px;
    }
    .card{
      background:var(--muted);
      padding:18px;
      border-radius:var(--radius);
    }
    .card h3{margin:0 0 10px 0; color:var(--bg-accent-1); font-size:13px}
    .field{display:flex; gap:12px; align-items:center; margin-bottom:10px}
    .field label{min-width:100px; font-weight:600; color:var(--text); font-size:13px}
    .field input[type="text"], .field input[type="date"], .field input[type="number"]{
      flex:1;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      font-size:13px;
      background:white;
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:6px 0 0 0;
    }
    .section-title h2{margin:0; font-size:16px; color:var(--bg-accent-1)}
    .section-title .actions{display:flex; gap:10px; align-items:center}

    #rooms {display:flex; flex-direction:column; gap:18px; margin-top:6px}

    .room{
      background:var(--muted);
      padding:18px;
      border-radius:var(--radius);
      display:flex;
      flex-direction:column;
      gap:12px;
      page-break-inside: avoid;
      break-inside: avoid;
      -webkit-column-break-inside: avoid;
    }
    .room-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .room-title{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .room-title input[type="text"]{
      font-size:16px;
      font-weight:700;
      border:none;
      background:transparent;
      color:var(--bg-accent-1);
      padding:6px 8px;
      border-bottom:2px dashed rgba(102,126,234,0.18);
      min-width:160px;
    }
    .room-controls{display:flex; gap:8px}

    .items{
      display:grid;
      gap:8px;
    }
    /* MODIFICATION: Grille optimisÃ©e pour mieux afficher les observations */
    .items .grid-head, .items .grid-row{
      display:grid;
      grid-template-columns: 1.5fr 60px 100px 2fr 50px;
      gap:8px;
      align-items:start;
      background:white;
      padding:8px;
      border-radius:8px;
      border:1px solid #eff2f6;
    }
    .grid-head{
      background:linear-gradient(90deg,var(--bg-accent-1),var(--bg-accent-2)); 
      color:white; 
      font-weight:700; 
      text-transform:uppercase; 
      font-size:11px;
      align-items:center;
    }
    .grid-row input[type="text"], .grid-row input[type="number"], .grid-row select, .grid-row textarea{
      width:100%;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #e6e9ef;
      font-size:12px;
      background:white;
    }
    /* MODIFICATION: Textarea avec hauteur minimale augmentÃ©e et overflow visible */
    .grid-row textarea{
      min-height:50px; 
      resize:vertical;
      overflow:visible;
      line-height:1.4;
      word-wrap:break-word;
      white-space:pre-wrap;
    }
    .small-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:0; border-radius:6px;
      padding:6px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .remove-item{background:var(--danger); color:white}

    .add-equip{
      align-self:start;
      background:var(--success);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      border:0;
      font-weight:700;
      cursor:pointer;
    }

    .observations{background:#fff8e1; padding:16px; border-radius:var(--radius); page-break-inside: avoid; break-inside: avoid}
    .observations textarea{width:100%; padding:12px; min-height:100px; border-radius:10px; border:1px solid #f0e6b8; resize:vertical; font-size:13px; line-height:1.5}

    .signatures{display:grid; grid-template-columns:1fr 1fr; gap:18px}
    .signature-box{background:var(--muted); padding:14px; border-radius:10px; text-align:left; page-break-inside: avoid; break-inside: avoid}

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:60;
    }
    .modal{
      width:min(720px,94%); background:white; border-radius:14px; padding:18px;
      box-shadow:0 20px 60px rgba(2,6,23,0.32);
    }
    .templates{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:12px}
    .tpl{
      display:flex; flex-direction:column; gap:6px; padding:12px; border-radius:10px; background:var(--muted); align-items:center; cursor:pointer; border:1px solid #e8eefc;
    }
    .tpl:hover{transform:translateY(-6px); transition:all .18s ease}

    .adresse-input {
      width: 100%;
      min-height: 50px;
      resize: vertical;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Compteurs */
    .compteurs-grid {
      display:grid; 
      grid-template-columns:repeat(3, 1fr); 
      gap:12px;
    }
    .compteurs-grid input {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      font-size:13px;
      background:white;
    }

    @media (max-width:900px){
      .info-grid{grid-template-columns:1fr}
      .signatures{grid-template-columns:1fr}
      .compteurs-grid{grid-template-columns:1fr}
      .items .grid-head, .items .grid-row{grid-template-columns: 1fr 60px 90px 1.5fr 40px}
    }
    @media (max-width:560px){
      .items .grid-head, .items .grid-row{grid-template-columns: 1fr; gap:6px; padding:10px}
      .grid-head > *{display:none}
      .grid-row > *{display:block}
      .grid-row textarea{min-height:60px}
      body{padding:10px}
      .content{padding:14px}
      .toolbar{padding:10px; flex-wrap:wrap}
      .toolbar .left, .toolbar .right{gap:6px}
      .btn{padding:8px 10px; font-size:12px}
      .header h1{font-size:22px}
    }

    /* Autocomplete adresse */
    .adresse-wrap{position:relative}
    .adresse-suggestions{
      position:absolute; top:100%; left:0; right:0; z-index:50;
      background:white; border:1px solid #e5e7eb; border-top:none;
      border-radius:0 0 8px 8px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
      max-height:220px; overflow-y:auto;
      display:none;
    }
    .adresse-suggestions.visible{display:block}
    .adresse-suggestion{
      padding:10px 12px; cursor:pointer; font-size:13px;
      border-bottom:1px solid #f3f4f6; color:#1f2937;
    }
    .adresse-suggestion:last-child{border-bottom:none}
    .adresse-suggestion:hover, .adresse-suggestion.active{
      background:#eef2ff; color:#667eea;
    }
    .adresse-suggestion small{display:block; color:#9ca3af; font-size:11px; margin-top:2px}

    /* ==================== STYLES D'IMPRESSION SANS ESPACES VIDES ==================== */
    @media print{
      /* Masquer les Ã©lÃ©ments interactifs */
      .toolbar, .btn, .btn.ghost, .btn.success, .btn.danger, .add-equip, .room-controls, .tpl, 
      .remove-item, .small-btn.remove-item, .no-print { 
        display:none !important; 
      }
      
      /* Reset global - marges minimales */
      body{
        background:white !important; 
        padding:0 !important;
        margin:0 !important;
        font-size:7pt !important;
        page-break-after: avoid;
      }
      
      .app{
        box-shadow:none !important;
        border-radius:0 !important;
        max-width:100% !important;
        width:100% !important;
        margin:0 !important;
        padding:0 !important;
        page-break-inside: avoid;
      }
      
      .content{
        padding:3mm 3mm !important;
        gap:0 !important;
        margin:0 !important;
        page-break-inside: avoid;
        display:grid;
      }
      
      /* Header minimaliste sur la premiÃ¨re page - centrÃ© verticalement et horizontalement */
      .header{
        padding:40px 30px !important;
        margin:0 !important;
        border-radius:0 !important;
        page-break-inside: avoid;
        page-break-after: always;
        min-height:150mm;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-direction:column;
        text-align:center;
      }
      .header h1{font-size:24pt !important; margin:0 0 8mm 0 !important; font-weight:700 !important}
      .header p{font-size:12pt !important; margin:0 !important}
      .header small{font-size:6pt !important; display:none !important}
      .header > div{text-align:center !important}
      
      /* Cards ultra-compacts */
      .card{ 
        box-shadow: none !important; 
        background: #f9f9f9 !important; 
        border: 1px solid #bbb !important;
        padding: 2mm 2mm !important;
        margin:0 0 1mm 0 !important;
        border-radius:0 !important;
        page-break-inside: avoid;
      }
      
      /* Rooms sans marge */
      .room {
        box-shadow: none !important; 
        background: #f9f9f9 !important; 
        border: 1px solid #bbb !important;
        padding: 2mm 2mm !important;
        margin:0 0 1mm 0 !important;
        border-radius:0 !important;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      .signature-box, .observations { 
        box-shadow: none !important; 
        background: #f9f9f9 !important; 
        border: 1px solid #bbb !important;
        padding: 2mm 2mm !important;
        margin:0 0 1mm 0 !important;
        page-break-inside: avoid; 
        break-inside: avoid;
        border-radius:0 !important;
      }
      
      .card h3{font-size:7pt !important; margin:0 0 1mm 0 !important}
      
      /* Champs formulaire trÃ¨s compacts */
      .field{margin:0 0 1mm 0 !important; gap:2mm !important}
      .field label{min-width:40px !important; font-size:6pt !important}
      .field input{font-size:6pt !important; padding:1mm 1mm !important; height:14px !important}
      
      /* Info grid sans espace */
      .info-grid{gap:1mm !important; margin:0 !important}
      
      /* Grille Ã©quipements SANS ESPACES */
      .items{gap:0 !important; margin:0 !important}
      
      .items .grid-head{
        display:grid !important;
        grid-template-columns: 2.5fr 25px 50px 3fr !important;
        gap:0 !important;
        padding:1mm 2mm !important;
        font-size:5pt !important;
        background:#667eea !important;
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
        border-radius:0 !important;
        margin:0 !important;
        page-break-inside: avoid;
      }
      .items .grid-head > *:last-child{display:none !important}
      
      .items .grid-row{
        display:grid !important;
        grid-template-columns: 2.5fr 25px 50px 3fr !important;
        gap:0 !important;
        padding:0.5mm 2mm !important;
        border:none !important;
        border-bottom:0.5pt solid #ddd !important;
        background:white !important;
        align-items:center !important;
        min-height:11px !important;
        margin:0 !important;
        page-break-inside: avoid;
      }
      .items .grid-row > *:last-child{display:none !important}
      
      /* Inputs grille minimalistes */
      .grid-row input[type="text"], 
      .grid-row input[type="number"], 
      .grid-row select{
        font-size:6pt !important;
        padding:0.5mm 1mm !important;
        border:none !important;
        background:transparent !important;
        height:11px !important;
        min-height:11px !important;
        line-height:11px !important;
      }
      
      /* TEXTAREA une ligne */
      .grid-row textarea{
        font-size:6pt !important;
        padding:0.5mm 1mm !important;
        border:none !important;
        background:transparent !important;
        min-height:11px !important;
        height:11px !important;
        overflow:hidden !important;
        resize:none !important;
        line-height:11px !important;
      }
      
      /* Select mini */
      .grid-row select{
        font-size:5pt !important;
        padding:0 !important;
        height:11px !important;
      }
      
      /* Section titres sans marge */
      .section-title{margin:1mm 0 0 0 !important; padding:0 !important; page-break-inside: avoid}
      .section-title h2{font-size:8pt !important; margin:0 !important}
      
      /* Room head compact */
      .room-head{margin:0 0 1mm 0 !important; padding:0 !important}
      .room-title{gap:3mm !important}
      .room-title input{font-size:8pt !important; padding:0 !important; border:none !important}
      .room-title div{font-size:10px !important}
      
      /* Observations minimales */
      .observations{
        background:#fffef5 !important;
        padding:2mm 3mm !important;
      }
      .observations textarea{
        font-size:6pt !important;
        padding:1mm !important;
        min-height:15mm !important;
        height:auto !important;
        border:1px solid #ddd !important;
        line-height:1.2 !important;
      }
      
      /* Signatures cÃ´te Ã  cÃ´te trÃ¨s compactes */
      .signatures{gap:3mm !important; margin:0 !important; page-break-inside: avoid}
      .signature-box{padding:2mm !important}
      .signature-box strong{font-size:7pt !important; margin:0 !important}
      .signature-box input{font-size:6pt !important; padding:0.5mm 1mm !important; height:12px !important}
      .signature-box label{font-size:5pt !important; display:block !important; margin:0 0 0.5mm 0 !important}
      .signature-box div[style*="border:2px dashed"]{
        padding:6mm 3mm !important;
        font-size:6pt !important;
        margin-top:1mm !important;
      }
      .signature-box > div{margin-top:1mm !important}
      
      /* Compteurs sur une ligne */
      .compteurs-grid{gap:2mm !important; margin:0 !important; page-break-inside: avoid}
      .compteurs-grid > div{display:flex !important; align-items:center !important; gap:2mm !important}
      .compteurs-grid label{font-size:6pt !important; margin:0 !important; white-space:nowrap !important}
      .compteurs-grid input{font-size:6pt !important; padding:1mm 1mm !important; width:50px !important; height:14px !important}
      
      /* Info box finale mini */
      div[style*="background:#e3f2fd"]{
        font-size:6pt !important;
        padding:1mm 2mm !important;
        border-radius:0 !important;
        margin:0 !important;
      }
      
      /* Adresse compact */
      .adresse-input{
        font-size:6pt !important;
        min-height:12mm !important;
        padding:1mm !important;
        height:auto !important;
      }
      
      /* Zone dates/type inline */
      .card > div[style*="display:flex"]{
        gap:2mm !important;
        flex-wrap:nowrap !important;
      }
      .card > div[style*="display:flex"] > div{
        width:auto !important;
        flex:1 !important;
      }
      .card > div[style*="display:flex"] label{
        font-size:6pt !important;
        margin:0 !important;
      }
      .card > div[style*="display:flex"] input[type="date"]{
        font-size:6pt !important;
        padding:0.5mm 1mm !important;
        height:14px !important;
      }
      
      /* Type EntrÃ©e/Sortie compact */
      .card > div[style*="display:flex"][style*="align-items:center"]{
        gap:2mm !important;
        padding:1mm 0 !important;
      }
      .card > div[style*="display:flex"][style*="align-items:center"] label{
        font-size:6pt !important;
        gap:1mm !important;
      }
      
      /* ============= SAUTS DE PAGE INTELLIGENTS ============= */
      
      /* Ã‰viter les coupures au milieu des piÃ¨ces */
      .room {
        page-break-inside: avoid;
        break-inside: avoid;
        -webkit-column-break-inside: avoid;
      }
      
      /* Ã‰viter les coupures dans les sections */
      .section-title {
        page-break-after: avoid;
      }
      
      /* Garder l'en-tÃªte avec le dÃ©but du contenu */
      .header {
        page-break-after: avoid;
      }
      
      /* Ã‰viter les coupures dans les observatrions */
      .observations {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* Garder les signatures ensemble */
      .signatures {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* Garder les compteurs ensemble */
      .compteurs-grid {
        page-break-inside: avoid;
      }
      
      /* Forcer un saut avant la section photos */
      #photo-section {
        page-break-before: always;
        margin-top: 0;
      }
      
      /* Images optimisÃ©es pour impression */
      img {
        max-height: 220mm;
        object-fit: contain;
        page-break-inside: avoid;
        margin:1mm 0;
      }
      
      /* Couleurs exactes */
      * { 
        -webkit-print-color-adjust:exact !important; 
        print-color-adjust:exact !important; 
      }
    }

    .no-print { display:inline-block; }
    .hide-when-export { display:inline-block; }

</style>
</head>
<body>

  <div class="app" id="app">
    <div class="toolbar" role="toolbar" aria-label="Barre d'outils">
      <div class="left">
        <h3>Ã‰TAT DES LIEUX â€“ moderne</h3>
      </div>
      <div class="right">
        <button class="btn ghost no-print" id="btn-charger" style="">ğŸ“‚ Charger</button>
        <input id="file-input" type="file" accept=".html" style="display:none">
        <button class="btn warn no-print" id="btn-effacer" style="">ğŸ—‘ï¸ Effacer donnÃ©es</button>
        <button class="btn no-print" id="btn-imprimer" style="">ğŸ–¨ï¸ Imprimer</button>
        <button class="btn positive no-print" id="btn-export-pdf" style="">ğŸ“„ Exporter en PDF</button>
        <button class="btn positive no-print" id="btn-enregistrer" style="">ğŸ’¾ Enregistrer HTML</button>
        
<button class="btn positive no-print" id="btn-add-photos" style="">ğŸ–¼ï¸ Ajouter des photos</button>
<button class="btn positive no-print" id="btn-take-photo" style="">ğŸ“· Prendre une photo</button>
<button class="btn success no-print" id="btn-send-email" style="">ğŸ“§ Envoyer par email</button>

  </div>
</div>

<!-- Bandeau installation PWA -->
<div id="pwa-install-banner" class="no-print" style="display:none; background:#f0fdf4; border:1px solid #86efac; border-radius:10px; padding:12px 18px; margin:0 28px; font-size:13px; color:#166534; line-height:1.5">
  <strong>ğŸ“² Installer l'app :</strong> Touchez <strong>Partager â†—ï¸</strong> puis <strong>"Sur l'Ã©cran d'accueil"</strong> pour utiliser cette app comme une vraie application.
  <button onclick="this.parentElement.style.display='none'" style="float:right; background:none; border:none; cursor:pointer; font-size:16px; color:#166534; padding:0 4px">âœ•</button>
</div>
<script>
  // Afficher le bandeau d'installation sur iOS Safari (pas en mode standalone)
  if (('standalone' in window.navigator) && !window.navigator.standalone && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.getElementById('pwa-install-banner').style.display = 'block';
  }

  // Enregistrement du Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(function(reg) {
      console.log('âœ… Service Worker enregistrÃ©', reg.scope);
    }).catch(function(err) {
      console.log('SW non enregistrÃ© :', err);
    });
  }
</script>

    <div class="content" id="content-root">
      <div class="header">
        <div style="text-align:center">
          <h1>Ã‰TAT DES LIEUX</h1>
          <p>Location saisonniÃ¨re meublÃ©e â€“ Document modernisÃ©</p>
        </div>
      </div>

      <div class="info-grid">
        <div class="card">
          <h3>ğŸ  PropriÃ©taire</h3>
          <div class="field">
            <label>Nom</label>
            <input type="text" id="owner-name" placeholder="Nom du propriÃ©taire">
          </div>
          <div class="field">
            <label>Adresse</label>
            <input type="text" placeholder="Adresse complÃ¨te" id="owner-address" class="adresse-autocomplete" autocomplete="off">
          </div>
          <div class="field">
            <label>TÃ©lÃ©phone</label>
            <input type="text" placeholder="TÃ©lÃ©phone" id="owner-phone">
          </div>
        </div>

        <div class="card">
          <h3>ğŸ‘¤ Locataire</h3>
          <div class="field">
            <label>Nom</label>
            <input type="text" id="tenant-name" placeholder="Nom du locataire">
          </div>
          <div class="field">
            <label>Adresse</label>
            <input type="text" placeholder="Adresse complÃ¨te" id="tenant-address" class="adresse-autocomplete" autocomplete="off">
          </div>
          <div class="field">
            <label>TÃ©lÃ©phone</label>
            <input type="text" placeholder="TÃ©lÃ©phone" id="tenant-phone">
          </div>
          <div class="field">
            <label>Email</label>
            <input type="text" placeholder="Email du locataire" id="tenant-email">
          </div>
        </div>
      </div>

      
<div class="card" id="photo-section">
  <h3>ğŸ“¸ Photos â€“ Ã‰tat des lieux</h3>
  <div id="photo-container" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px">
  </div>
</div>


<div class="card">
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <div style="flex:1; min-width:200px">
            <label style="font-weight:700; color:var(--muted-text); display:block; margin-bottom:6px; font-size:12px">ğŸ“ Adresse du logement</label>
            <input type="text" class="adresse-autocomplete adresse-input" placeholder="Adresse complÃ¨te du bien" id="property-address" autocomplete="off" style="height:auto; padding:10px">
          </div>
          <div style="width:180px">
            <label style="font-weight:700; color:var(--muted-text); display:block; margin-bottom:6px; font-size:12px">ğŸ“… Date d'entrÃ©e</label>
            <input type="date" id="date-entry" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc">
          </div>
          <div style="width:180px">
            <label style="font-weight:700; color:var(--muted-text); display:block; margin-bottom:6px; font-size:12px">ğŸ“… Date de sortie</label>
            <input type="date" id="date-exit" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc">
          </div>
        </div>
      </div>

      <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div style="display:flex; gap:12px; align-items:center">
          <label style="font-weight:700; font-size:13px">Type :</label>
          <label style="display:flex; gap:6px; align-items:center; font-size:13px"><input type="radio" name="etat" checked="" id="type-entry" value="entry"> EntrÃ©e</label>
          <label style="display:flex; gap:6px; align-items:center; font-size:13px"><input type="radio" name="etat" id="type-exit" value="exit"> Sortie</label>
        </div>
        <div style="display:flex; gap:12px;">
          <button class="btn ghost no-print btn-ajouter-piece" style="">+ Ajouter une piÃ¨ce</button>
        </div>
      </div>

      <div>
        <div class="section-title">
          <h2>PiÃ¨ces et Ã©quipements</h2>
          <div class="actions">
            <button class="btn success no-print btn-ajouter-piece" style="">+ Ajouter une piÃ¨ce</button>
          </div>
        </div>

        <div id="rooms"><section class="room" data-room-id="room-1"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸ³</div>
        <input type="text" value="Cuisine" id="field-rgqls3z1v"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-1</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="RÃ©frigÃ©rateur" placeholder="Nom de l'Ã©quipement" id="field-30aadtm8c">
        <input type="number" value="1" min="0" id="field-cdauwe3hp">
        <select id="field-7q5gilsaj">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-bphtlga39" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Four" placeholder="Nom de l'Ã©quipement" id="field-znfqyjj56">
        <input type="number" value="1" min="0" id="field-ft4nytsae">
        <select id="field-7m6h0vfbr">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-te6oxmluk" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Plaques de cuisson" placeholder="Nom de l'Ã©quipement" id="field-7zev8r8ru">
        <input type="number" value="1" min="0" id="field-sflw9hx8k">
        <select id="field-v1wihancp">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-mn8hxw0tj" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Micro-ondes" placeholder="Nom de l'Ã©quipement" id="field-q22yhc40l">
        <input type="number" value="1" min="0" id="field-3t35zjv3s">
        <select id="field-izfrl4yde">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-ayatl4q9a" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Lave-vaisselle" placeholder="Nom de l'Ã©quipement" id="field-hw96gg7nx">
        <input type="number" value="1" min="0" id="field-laph1fgdv">
        <select id="field-s58gb7zyy">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-fkex0wm3v" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="CafetiÃ¨re" placeholder="Nom de l'Ã©quipement" id="field-7grgryr15">
        <input type="number" value="1" min="0" id="field-0wsysus5d">
        <select id="field-zjvudi7wz">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-kz5pwmw52" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Vaisselle complÃ¨te" placeholder="Nom de l'Ã©quipement" id="field-cgkyut83z">
        <input type="number" value="1" min="0" id="field-tdf1z3dgz">
        <select id="field-lpipw5gjc">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-f3g2ow4eh" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-tklqlkghs">
        <input type="number" value="1" min="0" id="field-7471hrqbs">
        <select id="field-zjl2c190r">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-m7lp8qbai" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-2qgte9akp">
        <input type="number" value="1" min="0" id="field-bdydv4d0m">
        <select id="field-69j97gw58">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-d138kzi3c" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-s8axvsrh1">
        <input type="number" value="1" min="0" id="field-7aw4wmcfo">
        <select id="field-a2xmtzho7">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-z8q9i9k24" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-brgm969vv">
        <input type="number" value="1" min="0" id="field-cbzql9ngf">
        <select id="field-9zci45rn6">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-5l4xz7l6g" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-mksebrcyf">
        <input type="number" value="1" min="0" id="field-gsisufsgb">
        <select id="field-zrhcbuygv">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-ts5xr0ppp" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section><section class="room" data-room-id="room-2"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸ›‹ï¸</div>
        <input type="text" value="Salon" id="field-cf29hjoom"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-2</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="CanapÃ©" placeholder="Nom de l'Ã©quipement" id="field-9y7k2mh4w">
        <input type="number" value="1" min="0" id="field-4luc5lgfr">
        <select id="field-m3q22x8ol">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-luiuusdz8" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Table basse" placeholder="Nom de l'Ã©quipement" id="field-i09ga1lb8">
        <input type="number" value="1" min="0" id="field-b6rhuixan">
        <select id="field-jaa2dndda">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-f5ve9xmm0" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="TÃ©lÃ©viseur" placeholder="Nom de l'Ã©quipement" id="field-yc47wjicw">
        <input type="number" value="1" min="0" id="field-bds189ciy">
        <select id="field-0kzwt89rv">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-mjff3gac9" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Rideaux/Voilages" placeholder="Nom de l'Ã©quipement" id="field-0iu87g5r5">
        <input type="number" value="1" min="0" id="field-wxdf6rxqo">
        <select id="field-dw31omtge">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-3al6o1yr5" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-v7pbgmhmx">
        <input type="number" value="1" min="0" id="field-m5fflkm85">
        <select id="field-r0j3diwhb">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-zwrhzwf4r" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section><section class="room" data-room-id="room-3"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸ›ï¸</div>
        <input type="text" value="Chambre" id="field-t1751cx1j"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-3</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="Lit" placeholder="Nom de l'Ã©quipement" id="field-mvhbhulef">
        <input type="number" value="1" min="0" id="field-zhpg85jzg">
        <select id="field-frzunc4p5">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-76p572faq" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Armoire/Placard" placeholder="Nom de l'Ã©quipement" id="field-utkyrwypt">
        <input type="number" value="1" min="0" id="field-3fwb7rvg3">
        <select id="field-030fyn0nb">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-fi6kequjr" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Table de chevet" placeholder="Nom de l'Ã©quipement" id="field-wr62qgbkn">
        <input type="number" value="1" min="0" id="field-mie67haup">
        <select id="field-uny63h8xb">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-om4oz3jtf" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-sam7zl5kp">
        <input type="number" value="1" min="0" id="field-286tz92h0">
        <select id="field-o2j3pcbef">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-72l2arr2d" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section><section class="room" data-room-id="room-4"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸš¿</div>
        <input type="text" value="Salle de bain" id="field-h0i0zc7ac"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-4</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="Lavabo" placeholder="Nom de l'Ã©quipement" id="field-xvuxgy1x4">
        <input type="number" value="1" min="0" id="field-uj3bg95k6">
        <select id="field-7x62uv42i">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-rf6e7cx2k" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Douche/Baignoire" placeholder="Nom de l'Ã©quipement" id="field-vzq79a9zr">
        <input type="number" value="1" min="0" id="field-epjh78ys4">
        <select id="field-ga9big1h5">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-duvq31lc3" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="WC" placeholder="Nom de l'Ã©quipement" id="field-3qj5kjk7o">
        <input type="number" value="1" min="0" id="field-gu95btdu8">
        <select id="field-u9i4nf1iq">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-dtzoiz4e5" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Miroir" placeholder="Nom de l'Ã©quipement" id="field-8tmpfxpft">
        <input type="number" value="1" min="0" id="field-qmfe2vyzd">
        <select id="field-luuqqs6ky">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-m9q9rd6pj" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-cwbyyip7s">
        <input type="number" value="1" min="0" id="field-kjd24naff">
        <select id="field-j8kyvpvqm">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-55xaja32s" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-au8gy1b2r">
        <input type="number" value="1" min="0" id="field-e7cqedg3d">
        <select id="field-jvuk3c14s">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-dhq2reva4" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-pm7hp1ifk">
        <input type="number" value="1" min="0" id="field-683769wr6">
        <select id="field-pwwriggr2">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-u7l66ojuq" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-1whpbt6ip">
        <input type="number" value="1" min="0" id="field-8psnaw8rm">
        <select id="field-qk3vuz2te">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-vmmt03je0" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section><section class="room" data-room-id="room-5"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸ›ï¸</div>
        <input type="text" value="Chambre" id="field-23s2lukue"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-5</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="Lit" placeholder="Nom de l'Ã©quipement" id="field-qtrsj71p1">
        <input type="number" value="" min="0" id="field-ejkgo6leh">
        <select id="field-f5j7vcd02">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-261tg5pk8" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Armoire/Placard" placeholder="Nom de l'Ã©quipement" id="field-sjm1flpy7">
        <input type="number" value="" min="0" id="field-9von8hbeh">
        <select id="field-n0in3ktc5">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-on2nu9nlb" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Table de chevet" placeholder="Nom de l'Ã©quipement" id="field-gcspk112a">
        <input type="number" value="" min="0" id="field-rik4q8op4">
        <select id="field-r5aqbwwou">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-n5olsbgim" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section><section class="room" data-room-id="room-6"><div class="room-head"><div class="room-title"><div style="font-size:20px">ğŸ›ï¸</div>
        <input type="text" value="Chambre" id="field-v0e82l33k"></div><div class="room-controls"><div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: room-6</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size: 12px; padding: 6px 10px;">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size: 12px; padding: 6px 10px;">Supprimer</button></div></div><div class="items"><div class="grid-head"><div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print" style="">Action</div></div><div class="grid-row">
        <input type="text" value="Lit" placeholder="Nom de l'Ã©quipement" id="field-p02vc7t6k">
        <input type="number" value="" min="0" id="field-427dhbdkp">
        <select id="field-tqeasqlfx">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-vve7dw9jf" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Armoire/Placard" placeholder="Nom de l'Ã©quipement" id="field-bbriadmsq">
        <input type="number" value="" min="0" id="field-0bb50kz08">
        <select id="field-6w9nsunco">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-s77ngxi0d" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="Table de chevet" placeholder="Nom de l'Ã©quipement" id="field-54jd8hlsd">
        <input type="number" value="" min="0" id="field-d447plxck">
        <select id="field-vnyznakkh">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-efqr33x6w" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-b5b1p0w6a">
        <input type="number" value="1" min="0" id="field-txdp3eus7">
        <select id="field-uufbzyao8">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-w9nz0iezv" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-bhe8ixsbl">
        <input type="number" value="1" min="0" id="field-gealgfg02">
        <select id="field-8lwqtqnkk">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-8uoxy3a5x" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-f7pgx0jzh">
        <input type="number" value="1" min="0" id="field-6tinwrcf2">
        <select id="field-q9nniyx3e">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-ex22995t1" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div><div class="grid-row">
        <input type="text" value="" placeholder="Nom de l'Ã©quipement" id="field-k4kst6tox">
        <input type="number" value="1" min="0" id="field-ytvxwimix">
        <select id="field-23bhmjeh6">
          <option value="neuf">Neuf</option>
          <option value="tres-bon">TrÃ¨s bon</option>
          <option value="bon" selected="">Bon</option>
          <option value="moyen">Moyen</option>
          <option value="mauvais">Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-rexzwpvxp" style="height: 50px; overflow: hidden; line-height: 1.1;"></textarea>
        <button class="small-btn remove-item no-print" style="">âœ•</button>
      </div></div><button class="add-equip no-print" style="">+ Ajouter un Ã©quipement</button></section></div>
      </div>

      <div>
        <div class="section-title">
          <h2>RelevÃ©s de compteurs</h2>
        </div>
        <div class="card">
          <div class="compteurs-grid">
            <div>
              <label style="display:block; font-weight:700; color:var(--muted-text); font-size:12px; margin-bottom:4px">âš¡ Ã‰lectricitÃ© (kWh)</label>
              <input type="number" placeholder="Index en kWh" id="meter-electricity">
            </div>
            <div>
              <label style="display:block; font-weight:700; color:var(--muted-text); font-size:12px; margin-bottom:4px">ğŸ’§ Eau (mÂ³)</label>
              <input type="number" placeholder="Index en mÂ³" id="meter-water">
            </div>
            <div>
              <label style="display:block; font-weight:700; color:var(--muted-text); font-size:12px; margin-bottom:4px">ğŸ”¥ Gaz (mÂ³)</label>
              <input type="number" placeholder="Index en mÂ³" id="meter-gas">
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="section-title"><h2>Observations gÃ©nÃ©rales</h2></div>
        <div class="observations">
          <textarea placeholder="Notez ici toutes les observations particuliÃ¨res..." id="general-observations" style="height: 99px; overflow: hidden; line-height: 1.1;"></textarea>
        </div>
      </div>

      <div>
        <div class="section-title"><h2>Signatures</h2></div>
        <div class="signatures">
          <div class="signature-box">
            <strong>PropriÃ©taire / ReprÃ©sentant</strong>
            <div style="margin-top:8px">
              <label style="font-size:11px; color:var(--muted-text)">Date</label>
              <input type="date" id="signature-owner-date" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; margin-top:2px">
            </div>
            <div style="margin-top:8px">
              <label style="font-size:11px; color:var(--muted-text)">Nom et prÃ©nom</label>
              <input type="text" placeholder="Nom et prÃ©nom" id="signature-owner-name" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; margin-top:2px">
            </div>
            <div style="margin-top:10px">
              <label style="font-size:11px; color:var(--muted-text)">Signature (dessinez ci-dessous)</label>
              <canvas id="sig-owner" class="signature-canvas" width="400" height="160" style="width:100%; height:160px; border:2px dashed rgba(102,126,234,0.25); border-radius:8px; background:white; cursor:crosshair; touch-action:none"></canvas>
              <div id="sig-owner-img" style="display:none"><img style="width:100%; border-radius:8px; border:1px solid #ddd" /></div>
              <button class="btn ghost no-print" onclick="clearSignature('sig-owner')" style="margin-top:6px; padding:4px 10px; font-size:11px; color:#ef4444; border-color:#ef4444">âœ• Effacer signature</button>
            </div>
          </div>
          <div class="signature-box">
            <strong>Locataire</strong>
            <div style="margin-top:8px">
              <label style="font-size:11px; color:var(--muted-text)">Date</label>
              <input type="date" id="signature-tenant-date" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; margin-top:2px">
            </div>
            <div style="margin-top:8px">
              <label style="font-size:11px; color:var(--muted-text)">Nom et prÃ©nom</label>
              <input type="text" placeholder="Nom et prÃ©nom" id="signature-tenant-name" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; margin-top:2px">
            </div>
            <div style="margin-top:10px">
              <label style="font-size:11px; color:var(--muted-text)">Signature (dessinez ci-dessous)</label>
              <canvas id="sig-tenant" class="signature-canvas" width="400" height="160" style="width:100%; height:160px; border:2px dashed rgba(102,126,234,0.25); border-radius:8px; background:white; cursor:crosshair; touch-action:none"></canvas>
              <div id="sig-tenant-img" style="display:none"><img style="width:100%; border-radius:8px; border:1px solid #ddd" /></div>
              <button class="btn ghost no-print" onclick="clearSignature('sig-tenant')" style="margin-top:6px; padding:4px 10px; font-size:11px; color:#ef4444; border-color:#ef4444">âœ• Effacer signature</button>
            </div>
          </div>
        </div>
      </div>

      
<div style="margin-top:16px; padding:14px; background:#fff3cd; border:1px solid #ffeeba; border-radius:10px; color:#856404; font-size:12px">
  <strong>ğŸ“œ Clause dâ€™acceptation â€“ Location saisonniÃ¨re</strong><br>
  Toute anomalie non signalÃ©e par le locataire dans un dÃ©lai de <strong>24 heures</strong> suivant lâ€™entrÃ©e dans les lieux
  est rÃ©putÃ©e <strong>acceptÃ©e</strong> et lâ€™Ã©tat des lieux affichÃ© fera foi.
</div>


<div style="padding:12px; background:#e3f2fd; border-radius:10px; color:#1565c0; font-size:12px">
        <strong>â„¹ï¸ Information :</strong> Il est recommandÃ© d'Ã©tablir cet Ã©tat des lieux contradictoirement et d'accompagner le document de photos.
      </div>

    </div>
  </div>

  <div id="modal-root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // ========== TEMPLATES DE PIÃˆCES ==========
    // ========== TEMPLATES DE PIÃˆCES (VIDES) ==========
    const roomTemplates = {
      cuisine: { icon: 'ğŸ³', name: 'Cuisine', items: [
        {name:'RÃ©frigÃ©rateur',qty:''},{name:'Four',qty:''},{name:'Plaques de cuisson',qty:''},
        {name:'Micro-ondes',qty:''},{name:'Lave-vaisselle',qty:''},{name:'CafetiÃ¨re',qty:''},
        {name:'Vaisselle complÃ¨te',qty:''}
      ]},
      salon: { icon:'ğŸ›‹ï¸', name:'Salon', items:[
        {name:'CanapÃ©',qty:''},{name:'Table basse',qty:''},{name:'TÃ©lÃ©viseur',qty:''},{name:'Rideaux/Voilages',qty:''}
      ]},
      chambre: { icon:'ğŸ›ï¸', name:'Chambre', items:[
        {name:'Lit',qty:''},{name:'Armoire/Placard',qty:''},{name:'Table de chevet',qty:''}
      ]},
      sdb: { icon:'ğŸš¿', name:'Salle de bain', items:[
        {name:'Lavabo',qty:''},{name:'Douche/Baignoire',qty:''},{name:'WC',qty:''},{name:'Miroir',qty:''}
      ]},
      etatGeneral: { icon:'ğŸ ', name:'Ã‰tat GÃ©nÃ©ral', items:[
        {name:'Sol',qty:''},{name:'Murs',qty:''},{name:'Plafond',qty:''},{name:'Portes',qty:''},{name:'FenÃªtres',qty:''}
      ]},
      exterieur: { icon:'ğŸŒ³', name:'ExtÃ©rieur', items:[
        {name:'Terrasse/Balcon',qty:''},{name:'Mobilier extÃ©rieur',qty:''}
      ]},
      autre: { icon:'ğŸ“¦', name:'Autre piÃ¨ce', items:[] }
    };

    // ========== Ã‰TAT GLOBAL ==========
    const state = {
      roomCounter: 0,
      rooms: []
    };

    // ========== FONCTIONS UTILITAIRES ==========
    function $(sel, ctx=document){ return ctx.querySelector(sel) }
    function $all(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)) }
    function formatTodayISO(){ return new Date().toISOString().split('T')[0] }
    function generateId(){ return Math.random().toString(36).substr(2, 9) }

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) });
    }

    // Auto-expand amÃ©liorÃ© pour les textareas
    function autoExpand(ta){
      if(!ta) return;
      // Reset height to auto to get the correct scrollHeight
      ta.style.height = 'auto';
      // Set minimum height
      const minHeight = 50;
      // Calculate new height based on content
      const newHeight = Math.max(minHeight, ta.scrollHeight);
      ta.style.height = newHeight + 'px';
    }

    // ========== CRÃ‰ATION DES Ã‰LÃ‰MENTS DOM ==========
    
    // CrÃ©er une ligne d'Ã©quipement
    function createItemRowDOM(name='', qty=1, itemState='bon', obs=''){
      const row = document.createElement('div');
      row.className = 'grid-row';
      row.innerHTML = `
        <input type="text" value="${escapeHtml(name)}" placeholder="Nom de l'Ã©quipement" id="field-${generateId()}">
        <input type="number" value="${qty}" min="0" id="field-${generateId()}">
        <select id="field-${generateId()}">
          <option value="neuf" ${itemState==='neuf'?'selected':''}>Neuf</option>
          <option value="tres-bon" ${itemState==='tres-bon'?'selected':''}>TrÃ¨s bon</option>
          <option value="bon" ${itemState==='bon'?'selected':''}>Bon</option>
          <option value="moyen" ${itemState==='moyen'?'selected':''}>Moyen</option>
          <option value="mauvais" ${itemState==='mauvais'?'selected':''}>Mauvais</option>
        </select>
        <textarea placeholder="Observations / Remarques..." id="field-${generateId()}">${escapeHtml(obs)}</textarea>
        <button class="small-btn remove-item no-print">âœ•</button>
      `;
      
      // Attacher les Ã©vÃ©nements
      const ta = row.querySelector('textarea');
      // Attendre que le DOM soit prÃªt
      setTimeout(() => autoExpand(ta), 10);
      ta.addEventListener('input', () => autoExpand(ta));
      ta.addEventListener('blur', () => autoExpand(ta));
      
      const removeBtn = row.querySelector('.remove-item');
      removeBtn.addEventListener('click', function() {
        row.remove();
        saveStateToLocalStorage();
      });
      
      return row;
    }

    // CrÃ©er une piÃ¨ce complÃ¨te
    function createRoomDOM(room){
      const wrapper = document.createElement('section');
      wrapper.className = 'room';
      wrapper.dataset.roomId = room.id;

      const header = document.createElement('div');
      header.className = 'room-head';

      const titleWrap = document.createElement('div');
      titleWrap.className = 'room-title';
      titleWrap.innerHTML = `<div style="font-size:20px">${room.icon}</div>
        <input type="text" value="${escapeHtml(room.name)}" id="field-${generateId()}">`;

      const nameInput = titleWrap.querySelector('input');
      nameInput.addEventListener('change', function() {
        const r = state.rooms.find(r => r.id === room.id);
        if(r) {
          r.name = this.value;
          saveStateToLocalStorage();
        }
      });

      const controls = document.createElement('div');
      controls.className = 'room-controls';
      controls.innerHTML = `<div style="color:var(--muted-text); font-weight:600; align-self:center; font-size:11px">ID: ${room.id}</div>
        <button class="btn ghost no-print btn-dupliquer" style="font-size:12px; padding:6px 10px">Dupliquer</button>
        <button class="btn danger no-print btn-supprimer" style="font-size:12px; padding:6px 10px">Supprimer</button>`;

      // Attacher les Ã©vÃ©nements aux boutons de contrÃ´le
      const btnDupliquer = controls.querySelector('.btn-dupliquer');
      btnDupliquer.addEventListener('click', () => duplicateRoom(room.id));
      
      const btnSupprimer = controls.querySelector('.btn-supprimer');
      btnSupprimer.addEventListener('click', () => removeRoom(room.id));

      header.appendChild(titleWrap);
      header.appendChild(controls);

      const itemsBlock = document.createElement('div');
      itemsBlock.className = 'items';

      const head = document.createElement('div');
      head.className = 'grid-head';
      head.innerHTML = `<div>Ã‰quipement</div><div>QtÃ©</div><div>Ã‰tat</div><div>Observations</div><div class="no-print">Action</div>`;
      itemsBlock.appendChild(head);

      // Ajouter les Ã©quipements existants
      room.items.forEach(it => {
        const row = createItemRowDOM(it.name, it.qty, it.state || 'bon', it.obs || '');
        itemsBlock.appendChild(row);
      });

      // Bouton Ajouter un Ã©quipement
      const addBtn = document.createElement('button');
      addBtn.className = 'add-equip no-print';
      addBtn.textContent = '+ Ajouter un Ã©quipement';
      addBtn.addEventListener('click', function() {
        const newRow = createItemRowDOM('', 1, 'bon', '');
        itemsBlock.appendChild(newRow);
        newRow.querySelector('input[type="text"]').focus();
        attachFieldListeners();
        saveStateToLocalStorage();
      });

      wrapper.appendChild(header);
      wrapper.appendChild(itemsBlock);
      wrapper.appendChild(addBtn);

      return wrapper;
    }

    // ========== GESTION DES PIÃˆCES ==========
    
    function renderRooms(){
      const container = document.getElementById('rooms');
      container.innerHTML = '';
      state.rooms.forEach(r => container.appendChild(createRoomDOM(r)));
      attachFieldListeners();
      // Auto-expand toutes les textareas aprÃ¨s rendu
      setTimeout(() => {
        document.querySelectorAll('.grid-row textarea').forEach(ta => autoExpand(ta));
      }, 50);
    }

    function addRoomFromTemplate(key){
      const tpl = roomTemplates[key] || roomTemplates.autre;
      state.roomCounter += 1;
      const newRoom = {
        id: `room-${state.roomCounter}`,
        icon: tpl.icon,
        name: tpl.name,
        items: tpl.items.map(i => ({name:i.name, qty:i.qty, state:'bon', obs:''}))
      };
      state.rooms.push(newRoom);
      
      const container = document.getElementById('rooms');
      const newRoomEl = createRoomDOM(newRoom);
      container.appendChild(newRoomEl);
      
      attachFieldListeners();
      saveStateToLocalStorage();
      closeModal();
      setTimeout(()=>{ newRoomEl.scrollIntoView({behavior:'smooth', block:'center'}) }, 80);
    }

    function removeRoom(id){
      if(!confirm('Supprimer cette piÃ¨ce et tous ses Ã©quipements ?')) return;
      state.rooms = state.rooms.filter(r => r.id !== id);
      renderRooms();
      saveStateToLocalStorage();
    }

    function duplicateRoom(id){
      const orig = state.rooms.find(r => r.id === id);
      if(!orig) return;
      state.roomCounter += 1;
      const copy = {
        id: `room-${state.roomCounter}`,
        icon: orig.icon,
        name: orig.name + ' (copie)',
        items: orig.items.map(it => ({name: it.name, qty: it.qty, state: it.state || 'bon', obs: it.obs || ''}))
      };
      state.rooms.push(copy);
      renderRooms();
      saveStateToLocalStorage();
    }

    // ========== MODAL ==========
    
    function openTemplateModal(){
      const root = document.getElementById('modal-root');
      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <h3>Choisir le type de piÃ¨ce</h3>
              <button class="btn ghost no-print btn-fermer-modal">Fermer</button>
            </div>
            <div class="templates">
              ${Object.entries(roomTemplates).map(([k,t]) => `
                <div class="tpl" data-key="${k}">
                  <div style="font-size:28px">${t.icon}</div>
                  <div style="font-weight:700; font-size:12px">${t.name}</div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top:12px">
              <button class="btn ghost no-print btn-annuler-modal">Annuler</button>
            </div>
          </div>
        </div>
      `;
      
      // Attacher les Ã©vÃ©nements
      root.querySelector('.modal-backdrop').addEventListener('click', function(e) {
        if(e.target === this) closeModal();
      });
      root.querySelector('.btn-fermer-modal').addEventListener('click', closeModal);
      root.querySelector('.btn-annuler-modal').addEventListener('click', closeModal);
      
      root.querySelectorAll('.tpl').forEach(tpl => {
        tpl.addEventListener('click', function() {
          addRoomFromTemplate(this.dataset.key);
        });
      });
    }

    function closeModal(){
      document.getElementById('modal-root').innerHTML = '';
    }

    // ========== SAUVEGARDE / CHARGEMENT ==========
    
    function saveStateToLocalStorage() {
      try {
        const rooms = [];
        document.querySelectorAll('.room').forEach(roomEl => {
          const roomId = roomEl.dataset.roomId;
          const roomName = roomEl.querySelector('.room-title input')?.value || '';
          const roomIcon = roomEl.querySelector('.room-title div')?.textContent || 'ğŸ“¦';
          
          const items = [];
          roomEl.querySelectorAll('.grid-row').forEach(row => {
            const inputs = row.querySelectorAll('input, select, textarea');
            if (inputs.length >= 4) {
              items.push({
                name: inputs[0].value || '',
                qty: parseInt(inputs[1].value) || 1,
                state: inputs[2].value || 'bon',
                obs: inputs[3].value || ''
              });
            }
          });
          
          rooms.push({ id: roomId, icon: roomIcon, name: roomName, items });
        });
        
        state.rooms = rooms;
        localStorage.setItem('etatDesLieuxRooms', JSON.stringify(rooms));
        localStorage.setItem('etatDesLieuxCounter', state.roomCounter.toString());
        
        // Sauvegarder aussi les champs gÃ©nÃ©raux
        document.querySelectorAll('input, textarea, select').forEach(field => {
          if (field.id && !field.id.startsWith('field-')) {
            localStorage.setItem(field.id, field.value);
          }
        });
      } catch (err) {
        console.error('Erreur lors de la sauvegarde:', err);
      }
    }

    function loadStateFromLocalStorage() {
      try {
        const savedRooms = localStorage.getItem('etatDesLieuxRooms');
        const savedCounter = localStorage.getItem('etatDesLieuxCounter');
        
        if (savedRooms) {
          const rooms = JSON.parse(savedRooms);
          state.rooms = rooms;
          state.roomCounter = savedCounter ? parseInt(savedCounter) : rooms.length;
          
          if (rooms.length > 0) {
            renderRooms();
            return true;
          }
        }
      } catch (err) {
        console.error('Erreur lors du chargement:', err);
      }
      return false;
    }

    function loadData() {
      document.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.id && !field.id.startsWith('field-')) {
          const savedValue = localStorage.getItem(field.id);
          if (savedValue) {
            field.value = savedValue;
            if (field.tagName === 'TEXTAREA') {
              autoExpand(field);
            }
          }
        }
      });
    }

    function attachFieldListeners() {
      document.querySelectorAll('input, textarea, select').forEach(field => {
        field.removeEventListener('change', saveStateToLocalStorage);
        field.removeEventListener('input', saveStateToLocalStorage);
        
        if (field.tagName === 'TEXTAREA' || field.type === 'text') {
          field.addEventListener('input', saveStateToLocalStorage);
        } else {
          field.addEventListener('change', saveStateToLocalStorage);
        }
      });
    }

    function clearAllData() {
      if (confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir effacer toutes les donnÃ©es sauvegardÃ©es ?')) {
        localStorage.clear();
        location.reload();
      }
    }

    // ========== EXPORT / IMPORT ==========
    
    function downloadHTML(){
      try {
        // Avant export, ajuster toutes les textareas
        document.querySelectorAll('textarea').forEach(ta => autoExpand(ta));
        
        const modalRoot = document.getElementById('modal-root');
        const modalBackup = modalRoot.innerHTML;
        modalRoot.innerHTML = '';
        const docHtml = '<!doctype html>\n' + document.documentElement.outerHTML;
        modalRoot.innerHTML = modalBackup;
        const blob = new Blob([docHtml], {type:'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const tenant = (document.getElementById('tenant-name')?.value || 'locataire').replace(/\s+/g,'_');
        const now = new Date().toISOString().split('T')[0];
        a.download = `Etat_des_lieux_${tenant}_${now}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert('âœ… Le fichier HTML complet a Ã©tÃ© gÃ©nÃ©rÃ© et tÃ©lÃ©chargÃ©.');
      } catch (err) {
        alert('Erreur lors de la gÃ©nÃ©ration du fichier : ' + err.message);
      }
    }

    function exportPdfFull(){
      const element = document.getElementById('app');
      if(!element) return alert('Ã‰lÃ©ment principal introuvable.');

      // Convertir les signatures en images
      if (typeof signaturesToImages === 'function') signaturesToImages();

      // PrÃ©parer le document pour l'export - textareas trÃ¨s compactes
      document.querySelectorAll('textarea').forEach(ta => {
        ta.style.height = 'auto';
        ta.style.height = Math.max(11, ta.scrollHeight) + 'px';
        ta.style.overflow = 'hidden';
        ta.style.lineHeight = '1.1';
      });

      // Masquer les Ã©lÃ©ments non imprimables
      const interactive = document.querySelectorAll('.no-print');
      interactive.forEach(el => el.style.display = 'none');

      // Configuration PDF ultra-compact
      const tenant = (document.getElementById('tenant-name')?.value || 'locataire').replace(/\s+/g,'_');
      const filename = `${tenant}_${new Date().toISOString().split('T')[0]}.pdf`;

      const opt = {
        margin: [3, 3, 5, 3],
        filename: filename,
        image: { type: 'jpeg', quality: 0.85 },
        html2canvas: { 
          scale: 2,
          useCORS: true, 
          logging: false,
          letterRendering: true
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css'] }
      };

      // Export
      html2pdf()
        .set(opt)
        .from(element)
        .save()
        .then(function() {
          interactive.forEach(el => el.style.display = '');
          document.querySelectorAll('textarea').forEach(ta => autoExpand(ta));
          if (typeof imagesToSignatures === 'function') imagesToSignatures();
        })
        .catch(function(err) {
          console.error('Erreur PDF:', err);
          interactive.forEach(el => el.style.display = '');
          if (typeof imagesToSignatures === 'function') imagesToSignatures();
          alert('Erreur durant l\'export PDF : ' + err.message);
        });
    }

    // ========== RÃ‰ATTACHER TOUS LES Ã‰VÃ‰NEMENTS (pour fichiers rechargÃ©s) ==========
    
    function reattachAllEvents() {
      // Nettoyer les anciens listeners en remplaÃ§ant les Ã©lÃ©ments
      ['btn-charger', 'btn-effacer', 'btn-imprimer', 'btn-export-pdf', 'btn-enregistrer'].forEach(id => {
        const oldBtn = document.getElementById(id);
        if(oldBtn) {
          const newBtn = oldBtn.cloneNode(true);
          oldBtn.parentNode.replaceChild(newBtn, oldBtn);
        }
      });
      
      // Attacher les nouveaux listeners
      document.getElementById('btn-charger')?.addEventListener('click', () => document.getElementById('file-input').click());
      document.getElementById('btn-effacer')?.addEventListener('click', clearAllData);
      document.getElementById('btn-imprimer')?.addEventListener('click', () => {
        // Avant impression, ajuster les textareas
        document.querySelectorAll('textarea').forEach(ta => {
          ta.style.height = 'auto';
          ta.style.height = (ta.scrollHeight + 5) + 'px';
        });
        window.print();
      });
      document.getElementById('btn-export-pdf')?.addEventListener('click', exportPdfFull);
      document.getElementById('btn-enregistrer')?.addEventListener('click', downloadHTML);
      
      // Boutons "Ajouter une piÃ¨ce"
      document.querySelectorAll('.btn-ajouter-piece').forEach(btn => {
        btn.addEventListener('click', openTemplateModal);
      });
      
      // Chargement de fichier
      document.getElementById('file-input')?.addEventListener('change', function(e){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){
          const html = ev.target.result;
          try{
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            const loadedApp = tmp.querySelector('.app');
            if(loadedApp){
              document.getElementById('app').replaceWith(loadedApp);
              // RÃ©attacher les Ã©vÃ©nements aprÃ¨s chargement
              setTimeout(() => {
                reattachAllEvents();
                reattachRoomEvents();
                // Auto-expand les textareas
                document.querySelectorAll('textarea').forEach(ta => autoExpand(ta));
              }, 100);
              alert('âœ… Fichier chargÃ©. Les Ã©vÃ©nements ont Ã©tÃ© rÃ©attachÃ©s.');
            } else {
              alert('âš ï¸ Le fichier ne contient pas le format attendu (.app non trouvÃ©).');
            }
          } catch(err){
            alert('Erreur lors du chargement : ' + err.message);
          }
        };
        reader.readAsText(file);
      });
    }

    // RÃ©attacher les Ã©vÃ©nements sur les piÃ¨ces existantes (pour fichiers rechargÃ©s)
    function reattachRoomEvents() {
      document.querySelectorAll('.room').forEach(roomEl => {
        const roomId = roomEl.dataset.roomId;
        
        // Bouton Dupliquer
        const btnDupliquer = roomEl.querySelector('.btn-dupliquer, .btn.ghost:not(.btn-ajouter-piece)');
        if(btnDupliquer && btnDupliquer.textContent.includes('Dupliquer')) {
          btnDupliquer.addEventListener('click', () => duplicateRoom(roomId));
        }
        
        // Bouton Supprimer
        const btnSupprimer = roomEl.querySelector('.btn-supprimer, .btn.danger');
        if(btnSupprimer && btnSupprimer.textContent.includes('Supprimer')) {
          btnSupprimer.addEventListener('click', () => removeRoom(roomId));
        }
        
        // Bouton Ajouter un Ã©quipement
        const addEquipBtn = roomEl.querySelector('.add-equip');
        if(addEquipBtn) {
          addEquipBtn.addEventListener('click', function() {
            const itemsBlock = roomEl.querySelector('.items');
            const newRow = createItemRowDOM('', 1, 'bon', '');
            itemsBlock.appendChild(newRow);
            newRow.querySelector('input[type="text"]').focus();
            attachFieldListeners();
            saveStateToLocalStorage();
          });
        }
        
        // Boutons Supprimer Ã©quipement
        roomEl.querySelectorAll('.remove-item').forEach(btn => {
          btn.addEventListener('click', function() {
            this.closest('.grid-row').remove();
            saveStateToLocalStorage();
          });
        });
        
        // Input nom de piÃ¨ce
        const nameInput = roomEl.querySelector('.room-title input');
        if(nameInput) {
          nameInput.addEventListener('change', function() {
            const r = state.rooms.find(r => r.id === roomId);
            if(r) {
              r.name = this.value;
              saveStateToLocalStorage();
            }
          });
        }
        
        // Textareas auto-expand
        roomEl.querySelectorAll('textarea').forEach(ta => {
          autoExpand(ta);
          ta.addEventListener('input', () => autoExpand(ta));
          ta.addEventListener('blur', () => autoExpand(ta));
        });
      });
      
      // Mettre Ã  jour le state avec les piÃ¨ces existantes
      const existingRooms = document.querySelectorAll('.room');
      if(existingRooms.length > 0) {
        state.rooms = [];
        let maxCounter = 0;
        existingRooms.forEach(roomEl => {
          const roomId = roomEl.dataset.roomId;
          const match = roomId.match(/room-(\d+)/);
          if(match) {
            const num = parseInt(match[1]);
            if(num > maxCounter) maxCounter = num;
          }
          
          const roomName = roomEl.querySelector('.room-title input')?.value || '';
          const roomIcon = roomEl.querySelector('.room-title div')?.textContent || 'ğŸ“¦';
          
          const items = [];
          roomEl.querySelectorAll('.grid-row').forEach(row => {
            const inputs = row.querySelectorAll('input, select, textarea');
            if (inputs.length >= 4) {
              items.push({
                name: inputs[0].value || '',
                qty: parseInt(inputs[1].value) || 1,
                state: inputs[2].value || 'bon',
                obs: inputs[3].value || ''
              });
            }
          });
          
          state.rooms.push({ id: roomId, icon: roomIcon, name: roomName, items });
        });
        state.roomCounter = maxCounter;
      }
    }

    // ========== INITIALISATION ==========
    
    function init(){
      const generatedDateEl = document.getElementById('generated-date');
      if(generatedDateEl) {
        generatedDateEl.textContent = new Date().toLocaleDateString('fr-FR');
      }
      const entry = document.getElementById('date-entry');
      if(entry && !entry.value) entry.value = formatTodayISO();
      
      // Attacher les Ã©vÃ©nements de base
      reattachAllEvents();
      
      // VÃ©rifier s'il y a des piÃ¨ces existantes dans le DOM (fichier rechargÃ©)
      const existingRooms = document.querySelectorAll('.room');
      if(existingRooms.length > 0) {
        // Fichier rechargÃ© avec des piÃ¨ces - rÃ©attacher les Ã©vÃ©nements
        reattachRoomEvents();
      } else {
        // Nouveau fichier - charger depuis localStorage ou crÃ©er les piÃ¨ces par dÃ©faut
        const hasLoadedData = loadStateFromLocalStorage();
        if (!hasLoadedData) {
          ['cuisine','salon','chambre','sdb'].forEach(k => addRoomFromTemplate(k));
        }
      }
      
      // Charger les donnÃ©es des champs gÃ©nÃ©raux
      loadData();
      
      // Ajuster les textareas
      document.querySelectorAll('textarea').forEach(ta => {
        autoExpand(ta);
        ta.addEventListener('input', () => autoExpand(ta));
        ta.addEventListener('blur', () => autoExpand(ta));
      });
      
      attachFieldListeners();
    }
    
    // Appeler init au chargement du DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // ========== EXPORTS GLOBAUX (pour compatibilitÃ©) ==========
    window.init = init;
    window.openTemplateModal = openTemplateModal;
    window.addRoomFromTemplate = addRoomFromTemplate;
    window.removeRoom = removeRoom;
    window.duplicateRoom = duplicateRoom;
    window.autoExpand = autoExpand;
    window.closeModal = closeModal;
    window.downloadHTML = downloadHTML;
    window.exportPdfFull = exportPdfFull;
    window.saveStateToLocalStorage = saveStateToLocalStorage;
    window.loadStateFromLocalStorage = loadStateFromLocalStorage;
    window.attachFieldListeners = attachFieldListeners;
    window.clearAllData = clearAllData;
    window.reattachAllEvents = reattachAllEvents;
    window.reattachRoomEvents = reattachRoomEvents;
  </script>




<script>
// Fonction utilitaire pour ajouter une photo au conteneur
function addPhotoToContainer(dataUrl) {
  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';

  const img = document.createElement('img');
  img.src = dataUrl;
  img.style.width = '100%';
  img.style.borderRadius = '8px';
  img.style.border = '1px solid #ddd';
  img.style.pageBreakInside = 'avoid';

  const del = document.createElement('button');
  del.textContent = 'âœ•';
  del.className = 'no-print';
  del.style.position = 'absolute';
  del.style.top = '6px';
  del.style.right = '6px';
  del.style.background = '#ef4444';
  del.style.color = 'white';
  del.style.border = 'none';
  del.style.borderRadius = '50%';
  del.style.width = '24px';
  del.style.height = '24px';
  del.style.cursor = 'pointer';
  del.onclick = () => wrapper.remove();

  wrapper.appendChild(img);
  wrapper.appendChild(del);
  document.getElementById('photo-container').appendChild(wrapper);
}

// Bouton "Ajouter des photos" (depuis fichiers / galerie)
document.getElementById('btn-add-photos')?.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;
  input.onchange = () => {
    [...input.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = e => addPhotoToContainer(e.target.result);
      reader.readAsDataURL(file);
    });
  };
  input.click();
});

// Bouton "Prendre une photo" (accÃ¨s camÃ©ra)
document.getElementById('btn-take-photo')?.addEventListener('click', () => {
  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    // Mobile : ouvrir directement l'appareil photo natif
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.setAttribute('capture', 'environment');
    input.onchange = () => {
      if (input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => addPhotoToContainer(e.target.result);
        reader.readAsDataURL(input.files[0]);
      }
    };
    input.click();
  } else {
    // Desktop : flux webcam
    openCameraModal();
  }
});

// Modal camÃ©ra pour desktop
function openCameraModal() {
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.id = 'camera-modal';
  backdrop.style.zIndex = '100';

  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.maxWidth = '680px';
  modal.style.width = '94%';
  modal.style.padding = '20px';
  modal.style.textAlign = 'center';
  modal.style.background = 'white';
  modal.style.borderRadius = '14px';
  modal.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3)';
  modal.style.maxHeight = '90vh';
  modal.style.overflowY = 'auto';

  modal.innerHTML = `
    <h3 style="margin:0 0 12px 0; color:#667eea; font-size:16px">ğŸ“· Capture photo</h3>
    <div id="camera-status" style="margin:0 0 12px 0; padding:10px 14px; border-radius:8px; background:#eef2ff; color:#667eea; font-size:13px">
      â³ Recherche des camÃ©ras disponibles...
    </div>
    <video id="camera-video" autoplay playsinline muted style="width:100%; border-radius:10px; background:#000; max-height:360px; display:none"></video>
    <canvas id="camera-canvas" style="display:none"></canvas>
    <div id="camera-select-wrap" style="margin:10px 0; display:none">
      <label style="font-size:12px; color:#6b7280; font-weight:600">CamÃ©ra :</label>
      <select id="camera-select" style="padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px; margin-left:6px"></select>
    </div>
    <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
      <button id="camera-snap" class="btn success" disabled style="padding:10px 20px; border-radius:10px; font-weight:700; font-size:14px; border:0; cursor:pointer; opacity:0.5">
        ğŸ“¸ Capturer
      </button>
      <button id="camera-retry" class="btn" style="padding:10px 20px; border-radius:10px; font-weight:700; font-size:14px; border:0; cursor:pointer; background:#f59e0b; color:white; display:none">
        ğŸ”„ RÃ©essayer
      </button>
      <button id="camera-close" class="btn danger" style="padding:10px 20px; border-radius:10px; font-weight:700; font-size:14px; border:0; cursor:pointer; background:#ef4444; color:white">
        âœ• Fermer
      </button>
    </div>
    <div id="camera-error" style="display:none; margin:12px 0 0 0; background:#fef2f2; border:1px solid #fca5a5; border-radius:10px; padding:14px; text-align:left">
    </div>
    <div id="camera-diag" style="display:none; margin:12px 0 0 0; background:#f0fdf4; border:1px solid #86efac; border-radius:10px; padding:14px; text-align:left; font-size:12px; color:#166534">
      <strong>ğŸ” Diagnostic :</strong>
      <pre id="camera-diag-log" style="margin:6px 0 0 0; white-space:pre-wrap; font-size:11px; color:#374151; background:#f9fafb; padding:8px; border-radius:6px; max-height:150px; overflow-y:auto"></pre>
    </div>
  `;

  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);

  const video = document.getElementById('camera-video');
  const canvas = document.getElementById('camera-canvas');
  const errorDiv = document.getElementById('camera-error');
  const statusDiv = document.getElementById('camera-status');
  const snapBtn = document.getElementById('camera-snap');
  const retryBtn = document.getElementById('camera-retry');
  const selectWrap = document.getElementById('camera-select-wrap');
  const cameraSelect = document.getElementById('camera-select');
  const diagDiv = document.getElementById('camera-diag');
  const diagLog = document.getElementById('camera-diag-log');
  let currentStream = null;
  let diagLines = [];

  function log(msg) {
    diagLines.push('[' + new Date().toLocaleTimeString() + '] ' + msg);
    diagLog.textContent = diagLines.join('\n');
    diagDiv.style.display = 'block';
    console.log('ğŸ“· ' + msg);
  }

  function setStatus(msg, type) {
    const colors = {
      info: { bg: '#eef2ff', color: '#667eea' },
      success: { bg: '#f0fdf4', color: '#16a34a' },
      error: { bg: '#fef2f2', color: '#ef4444' },
      warn: { bg: '#fffbeb', color: '#d97706' }
    };
    const c = colors[type] || colors.info;
    statusDiv.style.background = c.bg;
    statusDiv.style.color = c.color;
    statusDiv.innerHTML = msg;
  }

  function showError(title, details) {
    errorDiv.style.display = 'block';
    errorDiv.innerHTML = `
      <p style="color:#ef4444; font-size:14px; margin:0 0 10px 0; font-weight:700">âš ï¸ ${title}</p>
      <div style="color:#6b7280; font-size:12px; line-height:1.6">${details}</div>
    `;
  }

  function stopStream() {
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
  }

  // Ã‰tape 1 : VÃ©rifier les prÃ©-requis
  async function checkPrerequisites() {
    log('VÃ©rification des prÃ©-requis...');

    // VÃ©rifier si l\'API existe
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      log('âŒ API mediaDevices non disponible');
      setStatus('âŒ API camÃ©ra non disponible', 'error');
      showError('API camÃ©ra non supportÃ©e', `
        Votre navigateur ne supporte pas l'accÃ¨s Ã  la camÃ©ra sur cette page.<br><br>
        <strong>Causes possibles :</strong><br>
        â€¢ La page n'est pas en HTTPS ou localhost<br>
        â€¢ Navigateur trop ancien<br><br>
        <strong>URL actuelle :</strong> <code>${window.location.protocol}//${window.location.host}</code>
      `);
      return false;
    }
    log('âœ… API mediaDevices disponible');

    // VÃ©rifier le protocole
    const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    log('Protocole : ' + window.location.protocol + ' / Host : ' + window.location.hostname + (isSecure ? ' (contexte sÃ©curisÃ©)' : ' (NON sÃ©curisÃ©)'));
    
    if (!isSecure) {
      setStatus('âš ï¸ Contexte non sÃ©curisÃ© â€” la camÃ©ra pourrait Ãªtre bloquÃ©e', 'warn');
    }

    return true;
  }

  // Ã‰tape 2 : Lister les camÃ©ras
  async function listDevices() {
    log('Ã‰numÃ©ration des pÃ©riphÃ©riques...');
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === 'videoinput');
      log('PÃ©riphÃ©riques vidÃ©o trouvÃ©s : ' + cameras.length);
      cameras.forEach((cam, i) => {
        log('  CamÃ©ra ' + (i+1) + ' : ' + (cam.label || '(nom masquÃ© - permission requise)') + ' [' + cam.deviceId.substring(0,8) + '...]');
      });
      return cameras;
    } catch(e) {
      log('âŒ Erreur Ã©numÃ©ration : ' + e.message);
      return [];
    }
  }

  // Ã‰tape 3 : Tenter d'ouvrir la camÃ©ra avec plusieurs stratÃ©gies
  async function tryStartCamera(deviceId) {
    stopStream();
    
    const strategies = [];
    
    if (deviceId) {
      strategies.push({ label: 'CamÃ©ra spÃ©cifique', constraints: { video: { deviceId: { exact: deviceId } }, audio: false } });
    }
    strategies.push({ label: 'Contraintes minimales', constraints: { video: true, audio: false } });
    strategies.push({ label: 'CamÃ©ra frontale', constraints: { video: { facingMode: 'user' }, audio: false } });
    strategies.push({ label: 'CamÃ©ra arriÃ¨re', constraints: { video: { facingMode: 'environment' }, audio: false } });
    strategies.push({ label: 'RÃ©solution basse', constraints: { video: { width: 320, height: 240 }, audio: false } });

    for (const strat of strategies) {
      log('Tentative : ' + strat.label + '...');
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(strat.constraints);
        log('âœ… SuccÃ¨s avec : ' + strat.label);
        video.srcObject = currentStream;
        video.style.display = 'block';
        snapBtn.disabled = false;
        snapBtn.style.opacity = '1';
        setStatus('âœ… CamÃ©ra active â€” ' + strat.label, 'success');
        errorDiv.style.display = 'none';
        retryBtn.style.display = 'none';

        // Maintenant qu'on a la permission, re-lister les camÃ©ras avec les noms
        const cameras = await listDevices();
        if (cameras.length > 1) {
          selectWrap.style.display = 'block';
          cameraSelect.innerHTML = '';
          cameras.forEach((cam, i) => {
            const opt = document.createElement('option');
            opt.value = cam.deviceId;
            opt.textContent = cam.label || ('CamÃ©ra ' + (i + 1));
            if (currentStream.getVideoTracks()[0].getSettings().deviceId === cam.deviceId) {
              opt.selected = true;
            }
            cameraSelect.appendChild(opt);
          });
        }
        return true;
      } catch(err) {
        log('âŒ Ã‰chec (' + strat.label + ') : ' + err.name + ' - ' + err.message);
      }
    }
    return false;
  }

  // Diagnostic d'erreur dÃ©taillÃ©
  function showDetailedError(cameras) {
    retryBtn.style.display = 'inline-flex';
    
    let errorContent = '';
    
    if (cameras.length === 0) {
      setStatus('âŒ Aucune camÃ©ra dÃ©tectÃ©e', 'error');
      errorContent = `
        <strong>Aucune camÃ©ra n'a Ã©tÃ© dÃ©tectÃ©e sur votre appareil.</strong><br><br>
        <strong>VÃ©rifications pour votre Lenovo :</strong><br>
        <div style="background:#fff; padding:10px; border-radius:8px; margin:8px 0; border:1px solid #e5e7eb">
          ğŸ“Œ <strong>Cache camÃ©ra physique</strong> : VÃ©rifiez qu'il n'y a pas un cache coulissant sur la camÃ©ra en haut de l'Ã©cran<br><br>
          ğŸ“Œ <strong>Touche clavier</strong> : Appuyez sur <kbd style="background:#e5e7eb; padding:2px 6px; border-radius:4px; font-size:11px">F8</kbd> ou la touche avec l'icÃ´ne ğŸ“· (parfois avec <kbd style="background:#e5e7eb; padding:2px 6px; border-radius:4px; font-size:11px">Fn</kbd>)<br><br>
          ğŸ“Œ <strong>Lenovo Vantage</strong> : Ouvrez l'application â†’ MatÃ©riel â†’ Audio/VidÃ©o â†’ VÃ©rifiez que la camÃ©ra n'est pas dÃ©sactivÃ©e<br><br>
          ğŸ“Œ <strong>Gestionnaire de pÃ©riphÃ©riques</strong> : Tapez "Gestionnaire de pÃ©riphÃ©riques" dans la barre de recherche Windows â†’ CamÃ©ras â†’ VÃ©rifiez qu'elle est activÃ©e (clic droit â†’ Activer)
        </div>
        <strong>Autre possibilitÃ© :</strong><br>
        Une autre application (Zoom, Teams, Skype...) utilise peut-Ãªtre la camÃ©ra. Fermez-la et rÃ©essayez.
      `;
    } else {
      setStatus('âŒ CamÃ©ra dÃ©tectÃ©e mais accÃ¨s refusÃ©', 'error');
      errorContent = `
        <strong>${cameras.length} camÃ©ra(s) dÃ©tectÃ©e(s) mais l'accÃ¨s est bloquÃ©.</strong><br><br>
        <div style="background:#fff; padding:10px; border-radius:8px; margin:8px 0; border:1px solid #e5e7eb">
          ğŸ“Œ <strong>Windows</strong> : ParamÃ¨tres â†’ ConfidentialitÃ© â†’ CamÃ©ra â†’ VÃ©rifiez que votre navigateur est autorisÃ©<br><br>
          ğŸ“Œ <strong>Navigateur</strong> : Cliquez sur l'icÃ´ne ğŸ”’ Ã  gauche de la barre d'adresse â†’ CamÃ©ra â†’ Autoriser â†’ <strong>Rechargez la page</strong><br><br>
          ğŸ“Œ <strong>Application en cours</strong> : Fermez les apps qui utilisent la camÃ©ra (Zoom, Teams, Skype...)<br><br>
          ğŸ“Œ <strong>Lenovo</strong> : VÃ©rifiez le cache physique et la touche <kbd style="background:#e5e7eb; padding:2px 6px; border-radius:4px; font-size:11px">F8</kbd>
        </div>
        <div style="margin-top:8px">
          <button onclick="navigator.clipboard.writeText(document.getElementById('camera-diag-log').textContent).then(()=>this.textContent='âœ… CopiÃ© !')" 
            style="background:#667eea; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:600">
            ğŸ“‹ Copier le diagnostic
          </button>
        </div>
      `;
    }
    
    showError('Impossible d\'accÃ©der Ã  la camÃ©ra', errorContent);
  }

  // Lancement principal
  async function initialize() {
    const ok = await checkPrerequisites();
    if (!ok) return;

    setStatus('â³ DÃ©tection des camÃ©ras...', 'info');
    const cameras = await listDevices();

    setStatus('â³ Tentative de connexion Ã  la camÃ©ra...', 'info');
    const success = await tryStartCamera(null);

    if (!success) {
      showDetailedError(cameras);
    }
  }

  // Changement de camÃ©ra via le sÃ©lecteur
  cameraSelect.addEventListener('change', () => {
    tryStartCamera(cameraSelect.value);
  });

  // Capturer
  snapBtn.addEventListener('click', () => {
    if (!currentStream) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
    addPhotoToContainer(dataUrl);
    log('ğŸ“¸ Photo capturÃ©e (' + canvas.width + 'x' + canvas.height + ')');
    setStatus('âœ… Photo ajoutÃ©e ! Vous pouvez continuer Ã  capturer.', 'success');
  });

  // RÃ©essayer
  retryBtn.addEventListener('click', () => {
    errorDiv.style.display = 'none';
    retryBtn.style.display = 'none';
    diagLines = [];
    diagLog.textContent = '';
    initialize();
  });

  // Fermer
  function closeCamera() {
    stopStream();
    backdrop.remove();
  }

  document.getElementById('camera-close').addEventListener('click', closeCamera);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeCamera();
  });

  // GO
  initialize();
}
</script>

<script>
// ========== SIGNATURE PAD (tactile + souris) ==========
function initSignaturePad(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let lastX = 0, lastY = 0;

  function resize() {
    const rect = canvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.scale(ratio, ratio);
    ctx.putImageData(imgData, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#1a1a2e';
  }

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
  }

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    const pos = getPos(e);
    lastX = pos.x;
    lastY = pos.y;
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  function stopDraw(e) {
    if (e) e.preventDefault();
    drawing = false;
  }

  // Mouse
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseleave', stopDraw);

  // Touch
  canvas.addEventListener('touchstart', startDraw, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', stopDraw);
  canvas.addEventListener('touchcancel', stopDraw);

  resize();
  window.addEventListener('resize', () => setTimeout(resize, 100));
}

function clearSignature(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // Masquer l'image et rÃ©afficher le canvas
  const imgDiv = document.getElementById(canvasId + '-img');
  if (imgDiv) imgDiv.style.display = 'none';
  canvas.style.display = 'block';
}
window.clearSignature = clearSignature;

// Convertir les canvas signatures en images (pour l'export PDF)
function signaturesToImages() {
  document.querySelectorAll('.signature-canvas').forEach(canvas => {
    const imgDiv = document.getElementById(canvas.id + '-img');
    if (!imgDiv) return;
    const img = imgDiv.querySelector('img');
    // VÃ©rifier si le canvas n'est pas vide
    const ctx = canvas.getContext('2d');
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let hasContent = false;
    for (let i = 3; i < data.length; i += 4) {
      if (data[i] > 0) { hasContent = true; break; }
    }
    if (hasContent) {
      img.src = canvas.toDataURL('image/png');
      imgDiv.style.display = 'block';
      canvas.style.display = 'none';
    }
  });
}

// Restaurer les canvas aprÃ¨s export
function imagesToSignatures() {
  document.querySelectorAll('.signature-canvas').forEach(canvas => {
    const imgDiv = document.getElementById(canvas.id + '-img');
    if (imgDiv) imgDiv.style.display = 'none';
    canvas.style.display = 'block';
  });
}

// Initialiser les pads
initSignaturePad('sig-owner');
initSignaturePad('sig-tenant');

// ========== ENVOYER PAR EMAIL EN PDF ==========
document.getElementById('btn-send-email')?.addEventListener('click', async function() {
  const btn = this;
  const originalText = btn.innerHTML;
  btn.innerHTML = 'â³ GÃ©nÃ©ration du PDF...';
  btn.disabled = true;

  try {
    // Convertir les signatures en images
    signaturesToImages();

    const element = document.getElementById('app');
    if (!element) throw new Error('Ã‰lÃ©ment principal introuvable');

    // PrÃ©parer le document
    document.querySelectorAll('textarea').forEach(ta => {
      ta.style.height = 'auto';
      ta.style.height = Math.max(11, ta.scrollHeight) + 'px';
      ta.style.overflow = 'hidden';
      ta.style.lineHeight = '1.1';
    });

    const interactive = document.querySelectorAll('.no-print');
    interactive.forEach(el => el.style.display = 'none');

    const tenant = (document.getElementById('tenant-name')?.value || 'locataire').replace(/\s+/g, '_');
    const tenantEmail = document.getElementById('tenant-email')?.value || '';
    const ownerName = document.getElementById('owner-name')?.value || 'PropriÃ©taire';
    const filename = `Etat_des_lieux_${tenant}_${new Date().toISOString().split('T')[0]}.pdf`;

    const opt = {
      margin: [3, 3, 5, 3],
      filename: filename,
      image: { type: 'jpeg', quality: 0.85 },
      html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['css'] }
    };

    // GÃ©nÃ©rer le PDF comme blob
    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');

    // Restaurer l'affichage
    interactive.forEach(el => el.style.display = '');
    document.querySelectorAll('textarea').forEach(ta => autoExpand(ta));
    imagesToSignatures();

    const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

    // MÃ©thode 1 : Web Share API (iOS Safari, Android)
    if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
      await navigator.share({
        title: 'Ã‰tat des lieux - ' + tenant,
        text: `Bonjour,\n\nVeuillez trouver ci-joint l'Ã©tat des lieux.\n\nCordialement,\n${ownerName}`,
        files: [pdfFile]
      });
      btn.innerHTML = 'âœ… EnvoyÃ© !';
    } else {
      // MÃ©thode 2 : TÃ©lÃ©charger le PDF + ouvrir mailto
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);

      const subject = encodeURIComponent('Ã‰tat des lieux - ' + tenant);
      const body = encodeURIComponent(`Bonjour,\n\nVeuillez trouver ci-joint l'Ã©tat des lieux.\n\nCordialement,\n${ownerName}`);
      const mailto = `mailto:${tenantEmail}?subject=${subject}&body=${body}`;
      
      setTimeout(() => {
        window.location.href = mailto;
      }, 500);

      btn.innerHTML = 'âœ… PDF tÃ©lÃ©chargÃ© ! Joignez-le Ã  l\'email.';
    }
  } catch (err) {
    if (err.name !== 'AbortError') {
      console.error('Erreur envoi:', err);
      alert('Erreur : ' + err.message);
    }
    // Restaurer
    document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
    imagesToSignatures();
  } finally {
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 3000);
  }
});
</script>

<script>
// ========== AUTOCOMPLÃ‰TION ADRESSES FRANÃ‡AISES ==========
// Utilise l'API Base Adresse Nationale (gratuite, sans clÃ© API)
(function() {
  let debounceTimer = null;
  let activeIndex = -1;

  document.querySelectorAll('.adresse-autocomplete').forEach(function(input) {
    // CrÃ©er le wrapper
    const parent = input.parentElement;
    const wrap = document.createElement('div');
    wrap.className = 'adresse-wrap';
    parent.insertBefore(wrap, input);
    wrap.appendChild(input);

    // CrÃ©er la liste de suggestions
    const list = document.createElement('div');
    list.className = 'adresse-suggestions';
    wrap.appendChild(list);

    // Saisie
    input.addEventListener('input', function() {
      const query = this.value.trim();
      activeIndex = -1;

      if (query.length < 3) {
        list.classList.remove('visible');
        list.innerHTML = '';
        return;
      }

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        fetch('https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(query) + '&limit=6')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            list.innerHTML = '';
            if (!data.features || data.features.length === 0) {
              list.classList.remove('visible');
              return;
            }

            data.features.forEach(function(f, i) {
              const props = f.properties;
              const div = document.createElement('div');
              div.className = 'adresse-suggestion';
              div.innerHTML = props.label + '<small>' + (props.context || '') + '</small>';
              div.dataset.index = i;
              div.addEventListener('click', function() {
                input.value = props.label;
                list.classList.remove('visible');
                list.innerHTML = '';
                input.dispatchEvent(new Event('change', { bubbles: true }));
              });
              list.appendChild(div);
            });

            list.classList.add('visible');
          })
          .catch(function() {
            list.classList.remove('visible');
          });
      }, 300);
    });

    // Navigation clavier
    input.addEventListener('keydown', function(e) {
      const items = list.querySelectorAll('.adresse-suggestion');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = Math.min(activeIndex + 1, items.length - 1);
        items.forEach(function(el, i) { el.classList.toggle('active', i === activeIndex); });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = Math.max(activeIndex - 1, 0);
        items.forEach(function(el, i) { el.classList.toggle('active', i === activeIndex); });
      } else if (e.key === 'Enter' && activeIndex >= 0) {
        e.preventDefault();
        items[activeIndex].click();
      } else if (e.key === 'Escape') {
        list.classList.remove('visible');
      }
    });

    // Fermer quand on clique ailleurs
    document.addEventListener('click', function(e) {
      if (!wrap.contains(e.target)) {
        list.classList.remove('visible');
      }
    });
  });
})();
</script>

</body></html>